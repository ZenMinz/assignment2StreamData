extends layout

block content
	h1 #{title}
	p Welcome to #{title}
	form#message-entry(method="post", action='javascript:getHashTags()')
		div.input
			input#latestTime(type='hidden', name='latestTime', value=0)
		div.actions
			input(type="submit")
			br

		br
		div.tagInput
	h2 Tweets
	button#test(onclick='getCheckedHashtag')
		| Next
	button#test2(onclick='stopStream()')
		| Stop
	div.field
		div#messages
	script.
		let tweets;
		let lastSeen = $('#latestTime').val();
		onload = function conversation() {
			let time = new Date();
			console.log(time);
			lastSeen = $('#latestTime').val();
			$.get('/twitter/twitter', function (data) {
				//console.log(data[2].url);
				console.log(data)
				displayTweet(data);
				
			});
			interval = setTimeout(conversation, 5000); 
		}
		var xhr;
		function stopRequest() {
			xhr.abort();
		}
		function sendRequest() {
			xhr = $.post('/twitter', function (data) {
				console.log(data);
			});
		}

		function stopStream() {
			console.log("try to stop");
			alert("try to stop");
			clearInterval(interval);
			$.post('/twitter/stop', function(data) {
				alert("Stop!!");
			});
		}
		function displayTweet(data) {
			for (let i = 0; i < data.length; i ++) {
				let tweet = data[i];
				let name = tweet.Name;
				let url = tweet.url;
				let text = tweet.text;
				let time2 = tweet.timestamp;
				let time = new Date(tweet.timestamp);
				let str =		`<div class="item">`;
				str +=			`<div class="ui tiny image">`;
				str +=				`<img src="${url}" height="50" width="50">`;
				str +=			`</div>`;
				str +=			`<div class="content">`;
				str +=				`<a class="header">${name}</a>`;
				str +=					`<div class="meta">`;
				str +=						`<span>Description</span>`;
				str +=					`</div>`;
				str +=					`<div class="Text">`;
				str +=						`<p>Text: ${text}</p>`;
				str +=					`</div>`;
				str +=					`<div class="extra">`;
				str +=						`On: ${time}`;
				str +=					`</div>`;
				str +=			`</div>`;
				str +=		`</div>`;
				
				$("#messages").prepend(str);
				//$('#latestTime').val(time2);	
			}
		}

		function getHashTags() {
			$.post('/twitter/hashTags', function (data) {
				displayHashTags(data);
				tweets = data;
			})
		}

		function displayHashTags(data) {
			$(".tagInput").empty();
			let str2 = `<div class="ui grid">`;
			for (let i = 0; i < data.length; i ++) {
				//let str = `<button type="button" class="btn btn-outline-primary">${data[i]}</button>`;
				//$(".tagInput").append(str);
				let str = `<div class="custom-control custom-checkbox">
								<input type="checkbox" class="custom-control-input" id="customCheck${i+1}">
								<label class="custom-control-label" for="customCheck${i+1}">${data[i]}</label>
							</div>`;
				str2 += `<div class="four wide column">`;
				str2 += `	<div class="ui toggle checkbox">
								<input type="checkbox" id=check${i + 1}>
								<label>${data[i]}</label>
							</div>`;
				str2 += `</div>`;
				//$(".tagInput").append(str2);
			}
			str2 += `</div>`;

			$(".tagInput").append(str2);

		}
		$("#test").click(function() {
			getCheckedHashtag();
		})

		function sendPostRequest(trend) {
			$.post('/twitter/stream', {'trend': trend}, function (data) {
				console.log(data);
			})
		}

		function getCheckedHashtag() {
			let selected = [];
			for (let i = 0; i < tweets.length; i++) {
				if ($(`#check${i+1}`).is(":checked")) {
					selected.push(tweets[i]);
				}
			}
			let length = selected.length;
			//selected = JSON.stringify(length);
			let str = selected.join(',');
			console.log(str);
			//for (let i = 0; i < length; i ++) {
			//sendPostRequest(selected[i]);
			//}
			sendPostRequest(str);


		}

		$(".btn").click(function() {
			$(".btn").css("background-color","yellow");
		})
